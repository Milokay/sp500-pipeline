{
  "steps": [
    {
      "id": "clone",
      "name": "gcr.io/cloud-builders/git",
      "args": ["clone", "https://github.com/Milokay/sp500-pipeline.git", "."]
    },
    {
      "id": "analyze",
      "name": "us-central1-docker.pkg.dev/sp500-dashboard-0215/sp500-dashboard/python-builder:latest",
      "entrypoint": "bash",
      "args": ["-c", "cd /workspace/sp500-portfolio && python main.py && LATEST=$$(ls -t data/output/sp500_analysis_*.xlsx | head -1) && cp \"$$LATEST\" /workspace/sp500-dashboard/data/sp500_analysis.xlsx && echo \"Copied: $$LATEST\""],
      "waitFor": ["clone"],
      "timeout": "1200s"
    },
    {
      "id": "validate",
      "name": "python:3.12-slim",
      "entrypoint": "python",
      "args": ["-c", "import os; path='/workspace/sp500-dashboard/data/sp500_analysis.xlsx'; size=os.path.getsize(path); assert size > 102400, f'File too small: {size} bytes'; print(f'Validation passed: {size:,} bytes')"],
      "waitFor": ["analyze"]
    },
    {
      "id": "build",
      "name": "gcr.io/cloud-builders/docker",
      "dir": "sp500-dashboard",
      "args": ["build", "-t", "us-central1-docker.pkg.dev/sp500-dashboard-0215/sp500-dashboard/sp500-dashboard:latest", "."],
      "waitFor": ["validate"]
    },
    {
      "id": "push",
      "name": "gcr.io/cloud-builders/docker",
      "args": ["push", "us-central1-docker.pkg.dev/sp500-dashboard-0215/sp500-dashboard/sp500-dashboard:latest"],
      "waitFor": ["build"]
    },
    {
      "id": "deploy",
      "name": "gcr.io/google.com/cloudsdktool/cloud-sdk",
      "entrypoint": "gcloud",
      "args": ["run", "deploy", "sp500-dashboard", "--image", "us-central1-docker.pkg.dev/sp500-dashboard-0215/sp500-dashboard/sp500-dashboard:latest", "--region", "us-central1", "--platform", "managed", "--allow-unauthenticated", "--port", "8080", "--memory", "512Mi", "--cpu", "1", "--min-instances", "0", "--max-instances", "3"],
      "waitFor": ["push"]
    }
  ],
  "timeout": "1800s",
  "options": {
    "logging": "CLOUD_LOGGING_ONLY",
    "machineType": "E2_HIGHCPU_8"
  },
  "images": [
    "us-central1-docker.pkg.dev/sp500-dashboard-0215/sp500-dashboard/sp500-dashboard:latest"
  ]
}
